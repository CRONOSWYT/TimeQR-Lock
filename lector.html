<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lector QR - TimeQRLock</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #e0f7fa;
        margin: 0;
        padding: 20px;
      }
      h2 {
        text-align: center;
      }
      #lector {
        margin: 0 auto;
        max-width: 400px;
      }
      .ok {
        color: green;
      }
      .fail {
        color: red;
      }
    </style>
  </head>
  <body>
    <h2>Lector QR - TimeQRLock</h2>
    <div id="lector"></div>
    <div id="resultados">
      <p><strong>Nombre:</strong> <span id="nombre"></span></p>
      <p><strong>Grado:</strong> <span id="grado"></span></p>
      <p><strong>Documento:</strong> <span id="doc"></span></p>
      <p><strong>Hora:</strong> <span id="hora"></span></p>
      <p id="estado"></p>
    </div>
    <script>
      const clave = "timeqrlock";
      const lector = new Html5Qrcode("lector");
      //activa el lector QR en el div con ID "lector"
      function mostrar(mensaje, ok) {
        // Funci√≥n para mostrar un mensaje en pantalla
        const estado = document.getElementById("estado");
        estado.textContent = mensaje; // Muestra el mensaje
        estado.className = ok ? "ok" : "fail"; // Cambia el color del texto seg√∫n si fue exitoso (ok=true) o fallido
      }
      function descifrarQR(qr) {
        try {
          //Intenta ejecutar algo que puede fallar
          const bytes = CryptoJS.AES.decrypt(qr, clave);
          // Intenta descifrar el contenido cifrado del QR usando la clave
          const texto = bytes.toString(CryptoJS.enc.Utf8);
          // Convierte los datos descifrados a texto legible (UTF-8)
          return JSON.parse(texto);
          //Convierte texto JSON en objeto JavaScript. Falla si el texto no es un JSON v√°lido
          // Convierte el texto (que est√° en formato JSON) a un objeto de JavaScript
          // Ejemplo: '{"nombre":"Carlos","grado":"6A"}' ‚Üí {nombre: "Carlos", grado: "6A"}
        } catch (error) {
          //Captura errores de try
          // üõë Si hubo un error al descifrar (por ejemplo, si el texto no estaba cifrado correctamente)
          return null;
          // Devuelve null (vac√≠o). Luego, en el programa principal, esto indica que el QR es inv√°lido.
        }
      }
      function mostrarDatos(data) {
        const ahora = new Date(); // Obtiene la hora actual
        document.getElementById("nombre").textContent = data.nombre;
        document.getElementById("grado").textContent = data.grado;
        document.getElementById("doc").textContent = data.documento;
        document.getElementById("hora").textContent = ahora.toLocaleString(); // el .toLocaleString sirve para poner hora o fecha pero este esta personalizado
        mostrar("‚úÖ Registro correcto", true);
      }
      function iniciar(camaraId) {
        // ‚ñ∂Ô∏è Inicia la lectura del QR usando la c√°mara seleccionada
        lector
          .start(
            camaraId,
            {
              fps: 30, // Escanea 10 veces por segundo
              qrbox: 250, // Tama√±o del √°rea de escaneo (cuadro visible)
              facingMode: "environment", // Usa la c√°mara trasera (si es posible)
            },
            (qr) => {
              // ‚úÖ Esta funci√≥n se ejecuta autom√°ticamente cuando se detecta un c√≥digo QR
              lector.stop(); // Detiene el lector despu√©s de leer un c√≥digo (solo 1 lectura)
              const datos = descifrarQR(qr); // Intenta descifrar el contenido
              // Verifica si los datos tienen la estructura correcta
              if (datos && datos.nombre && datos.grado && datos.documento) {
                mostrarDatos(datos); // Muestra los datos
                google.script.run.registrarDatos(datos);
                // Envia los datos a una hoja de c√°lculo de Google
              } else {
                mostrar("‚ùå QR inv√°lido", false);
              }
            }
          )
          // Captura errores de funciones asincr√≥nicas (promesas)
          .catch(() => {
            // ‚ö†Ô∏è Si hubo un error al iniciar la c√°mara (permiso denegado, no detectada, etc.)
            mostrar("‚ùå No se pudo iniciar la c√°mara", false);
          });
      }
      Html5Qrcode.getCameras().then((camaras) => {
        // üì∑ Obtiene la lista de c√°maras del dispositivo (frontal, trasera, etc.)
        let trasera = camaras.find((cam) =>
          /back|rear|environment/i.test(cam.label)
        );
        // Busca una c√°mara con nombre que indique que es trasera
        if (!trasera) trasera = camaras[0];
        // Si no encuentra una c√°mara trasera, usa la primera que haya
        if (trasera) iniciar(trasera.id);
        // Si encuentra una c√°mara, la usa para iniciar el esc√°ner
        else mostrar("üö´ No se encontr√≥ c√°mara", false);
        // Si no hay c√°maras disponibles, muestra error
      });
    </script>
  </body>
</html>
